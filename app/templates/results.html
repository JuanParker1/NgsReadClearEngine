<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genomefltr</title>
  <link rel="stylesheet" href="{{url_for('static',filename='css/main.css')}}">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <script>
      const  colors = [
        "#000000",
        "#00FF00",
        "#FF0000",
        "#01FFFE",
        "#FFA6FE",
        "#FFDB66",
        "#006401",
        "#010067",
        "#95003A",
        "#007DB5",
        "#FF00F6",
        "#FFEEE8",
        "#774D00",
        "#90FB92",
        "#0076FF",
        "#D5FF00",
        "#FF937E",
        "#6A826C",
        "#FF029D",
        "#FE8900",
        "#7A4782",
        "#7E2DD2",
        "#85A900",
        "#FF0056",
        "#A42400",
        "#00AE7E",
        "#683D3B",
        "#BDC6FF",
        "#263400",
        "#BDD393",
        "#00B917",
        "#9E008E",
        "#001544",
        "#C28C9F",
        "#FF74A3",
        "#01D0FF",
        "#004754",
        "#E56FFE",
        "#788231",
        "#0E4CA1",
        "#91D0CB",
        "#BE9970",
        "#968AE8",
        "#BB8800",
        "#43002C",
        "#DEFF74",
        "#00FFC6",
        "#FFE502",
        "#620E00",
        "#008F9C",
        "#98FF52",
        "#7544B1",
        "#B500FF",
        "#00FF78",
        "#FF6E41",
        "#005F39",
        "#6B6882",
        "#5FAD4E",
        "#A75740",
        "#A5FFD2",
        "#FFB167",
        "#009BFF",
        "#E85EBE"

      ]
  </script>
  <script type="module" src="{{url_for('static',filename='js/results.js')}}"></script>
  <script src="https://cdn.jsdelivr.net/npm/danfojs@0.3.3/lib/bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.1/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
</head>


<body class="font-sans">
  <div class='w-full h-screen bg-no-repeat bg-cover bg-white' >

    <div class="flex flex-col items-center justify-evenly mx-auto  h-full">
        <div>
            <h1 class="text-8xl my-4">Sum stat placeholder</h1>
        </div>
        <div  class="flex flex-row items-center" >
            <div class="border-2 mx-2 shadow-lg" >
                <canvas style="height: 480px; width: 640px" id="bar_chart" ></canvas>
            </div>
            <div class="flex flex-col justify-between border-2 mx-2 px-2 py-2 shadow-lg"   style="height: 480px;">
                <label class="
                px-2
                py-4
                text-center
                bg-white
                rounded-md
                shadow-md
                tracking-wide
                border-2 border-blue cursor-pointer
                hover:bg-green-600 hover:text-white
                ease-linear
                transition-all
                duration-150
                mx-3"
                onclick="toggle_unclassified()">toggle unclassified</label  >
        
                <div id="species_container" class="flex flex-col overflow-auto mx-3 px-1 border-2" style="height: 300px;">
                    <div id="top_species_container" class="flex flex-col py-2 border-b-4">
                    </div>

                    <div id="other_species_container" class="flex flex-col my-2">
                    </div>
                </div>
            </div>
            <div class="border-2 mx-2 shadow-lg" >
                <canvas style="height: 480px; width: 480px" id="pie_chart"> </canvas>
            </div>
        </div>
        <form class="my-4" id="export_btn" action="" method="POST">
            <input type="hidden" id="k_mer_threshold" name="k_mer_threshold" value="">
            <input type="hidden" id="species_list" name="species_list" value="">
            <label class="
                w-64
                px-2
                py-4
                text-center
                bg-white
                rounded-md
                shadow-md
                tracking-wide
                border-2 border-blue cursor-pointer
                hover:bg-green-600 hover:text-white
                ease-linear
                transition-all
                duration-150">
                <span class="mt-2 text-base leading-normal select-none animate-bounce ">Get Filtered Results</span>
                <input type="submit" value="Export" hidden>
            </label>
        </form>
    </div>
</div>
</body>

<script> 
    
    const species_container = document.getElementById("species_container");
    
    let new_index = []
    let new_data = {}
    const json_data = JSON.parse('{{ data|safe }}');
    Object.entries(json_data).map(([key, val]) => {
        new_data[key] = Object.values(val);
        new_index = Object.keys(val);
    })
    new_index = new_index.map((item) => parseFloat(item))
    df = new dfd.DataFrame(new_data, {index: new_index});
    
    //updates when pressing checkboxes
    let species_list = [...df.columns]
    const update_species_list = (item) => {
        if (species_list.includes(item)) {
            item_index = species_list.indexOf(item);
            species_list.splice(item_index, 1);
        } else {
            species_list.push(item)
        }
    }
    update_species_list("unclassified (taxid 0)");

    
    document.getElementById("species_list").value = [...species_list];

    const species_colors = {};
    species_list.forEach((item,idx) => {
        species_colors[item] = colors[idx]
    })
    
    //updates when moving the slider
    let k_mer_threshold = 0.01
    const update_k_mer_threshold = (new_val) => {
        document.getElementById("k_mer_threshold").value = new_val;
        k_mer_threshold = new_val;
    }
    update_k_mer_threshold(k_mer_threshold)

    let show_unclassified = false;
    
    let species_threshold = 5;
    const update_species_threshold = (new_val) => {
        species_threshold = new_val;
    }
    update_species_threshold(20)


    const draw_species_pie_chart = (chart) => {

        let sum_total = df.sum({axis: 1}).sum({axis: 0});
        const threshold_list = df.index.filter(item => item >= k_mer_threshold)

        let sum_classified_df = df.loc({ rows: threshold_list, columns: species_list }).sum({axis: 1});

        let sum_unclassified = sum_total - sum_classified_df.sum({axis: 0});
        let colors_classified = species_list.map((item) => species_colors[item]);


        sum_other_df = sum_classified_df.loc(sum_classified_df.lt(species_threshold)).sum()
        sum_classified_df = sum_classified_df.loc(sum_classified_df.gt(species_threshold))


        chart.data.labels = [...sum_classified_df.index, "other"]
        show_unclassified ? chart.data.labels.push("unclassified") : null;

        chart.data.datasets = [{
            label: 'Classified',
            data: [...sum_classified_df.values, sum_other_df],
            hoverOffset: 4,
            backgroundColor: [...colors_classified, "orange"]
            }
        ];
        show_unclassified ? chart.data.datasets[0].data.push(sum_unclassified) : null;
        show_unclassified ? chart.data.datasets[0].backgroundColor.push("blue") : null;


        chart.options.borderRadius = 10
        chart.options.radius = "75%"
        chart.options.plugins.legend.display = false;

        chart.update()
    }

    const draw_kmer_hist = (chart, pie_chart) => {

        sum_total_df = df.sum({axis: 0});
        const y_max = sum_total_df.max();
        sum_classified_df = df.loc({ columns: species_list }).sum({axis: 0});
        const classified_indexes = sum_classified_df.index
        const classified_values = classified_indexes.map((index) => {
            return index < k_mer_threshold ? 0 : sum_classified_df.loc([index]).values[0];
        })
        sum_classified_df = new dfd.Series(classified_values, { index: classified_indexes });
        sum_unclassified_df = sum_total_df.sub(sum_classified_df)
        const bins_x = sum_total_df.index
        const classified_y = sum_classified_df.values
        const unclassified_y = sum_unclassified_df.values


        chart.data.labels = bins_x
        chart.data.datasets = [
            {
                data: classified_y,
                backgroundColor: "orange",
                label: 'Classified'

            }
        ];
        
        show_unclassified ? chart.data.datasets.push({
                data: unclassified_y,
                backgroundColor: "blue",
                label: 'Unclassified'
            }) : null;


        chart.options = {
            onClick: (event) => { 

                const xTop = chart.chartArea.left;
                const xBottom = chart.chartArea.right;
                const xMin = chart.scales.x.min;
                const xMax = chart.scales.x.max;
                let newX = 0;

                if (event.x <= xBottom && event.x >= xTop) {
                    newX = Math.abs((event.x - xTop) / (xBottom - xTop));
                    newX = newX * (Math.abs(xMax - xMin)) + xMin;
                };
                update_k_mer_threshold(newX);
                draw_kmer_hist(chart, pie_chart)
                draw_species_pie_chart(pie_chart)
            },
            plugins: {
                title: {
                    display: true,
                    text: 'classification by threshold k-mer',
                    font: {
                        size: 24
                    }
                },
                annotation: {
                    annotations: {
                        line: {
                            type: 'line',
                            scaleID: 'x',
                            value: parseFloat(k_mer_threshold),
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    stacked: true,
                    type: 'linear',
                    min: 0.0,
                    max: 1.0,
                    offset: false,
                    title: {
                        display: true,
                        text: 'Percent Threshold',
                        font: {
                            size: 16
                        }
                    }
                },
                y: {
                    stacked: true,
                    type: 'logarithmic',
                    title: {
                        display: true,
                        text: 'Number of reads (log-scale)',
                        font: {
                            size: 16
                        }
                    }
                }
            }
        };
        chart.update()
    }


    const draw_species_list = () => {
        let sum_total = df.sum({axis: 1}).sum({axis: 0});
        const threshold_list = df.index.filter(item => item >= k_mer_threshold);
        let sum_classified_df = df.loc({ rows: threshold_list}).sum({axis: 1});
        
        let sort_index = sum_classified_df.sort_values({"ascending": false }).index
        let sorted_by_freq = sum_classified_df.iloc(sort_index).index
        sorted_by_freq = sorted_by_freq.filter(item => item != "unclassified (taxid 0)")

        
        const top_10_species = sorted_by_freq.slice(0,10).map((item) => {
            let toggle = document.createElement("label");
            toggle.setAttribute("id", "toggle_" + item);
            const checkbox = document.createElement("input");
            checkbox.setAttribute("type", "checkbox");
            checkbox.setAttribute("id", item);
            checkbox.setAttribute("class", "h-5 w-5")
            checkbox.checked = species_list.includes(item) ? true : false;

            checkbox.addEventListener("click", (change) => {
                const item = change.target.id;
                update_species_list(item);
                //update the species_list to sent to backend
                document.getElementById("species_list").value = [...species_list];
                draw_kmer_hist(bar_chart, pie_chart);
                draw_species_pie_chart(pie_chart);
                draw_species_list();
            });
            toggle.appendChild(checkbox);
            let label = document.createElement("span");
            label.innerText = item;
            toggle.appendChild(label);
            return toggle;
        });

        const other_species = sorted_by_freq.slice(10,).map((item) => {
            const listitem = document.createElement("li");
            const toggle = document.createElement("label");
            listitem.setAttribute("id", "toggle_" + item);
            const checkbox = document.createElement("input");
            checkbox.setAttribute("type", "checkbox");
            checkbox.setAttribute("id", item);
            checkbox.setAttribute("class", "h-5 w-5 mx-5")
            checkbox.checked = species_list.includes(item) ? true : false;

            checkbox.addEventListener("click", (change) => {
                const item = change.target.id;
                update_species_list(item);
                //update the species_list to sent to backend
                document.getElementById("species_list").value = [...species_list];
                draw_kmer_hist(bar_chart, pie_chart);
                draw_species_pie_chart(pie_chart);
                draw_species_list();
            });
            let label = document.createElement("span");
            label.innerText = item;
            toggle.appendChild(checkbox)
            toggle.appendChild(label);
            listitem.appendChild(toggle);
            return listitem;
        });

        const other_species_container = document.createElement("ul");
        const listitem = document.createElement("li");
        
        const label = document.createElement("span");
        label.innerText = "Other Organisms";
        const other_species_toggle = document.createElement("input");
        const other_species_label = document.createElement("label");

        other_species_toggle.setAttribute("type", "checkbox");
        other_species_toggle.setAttribute("value", "other");
        other_species_toggle.setAttribute("id", "toggle_other_species");
        other_species_toggle.setAttribute("class", "h-5 w-5");
        other_species_toggle.checked = !other_species_toggle.checked;

        other_species_toggle.addEventListener("click", (change) => {
            sorted_by_freq.slice(10,).forEach((item) => {
                update_species_list(item)
                document.getElementById(item).checked = change.target.checked ? true : false;
            });
            //update the species_list to sent to backend
            document.getElementById("species_list").value = [...species_list];
            draw_kmer_hist(bar_chart, pie_chart);
            draw_species_pie_chart(pie_chart);
            // draw_species_list();
        });

        other_species_label.appendChild(other_species_toggle)
        other_species_label.appendChild(label)


        listitem.appendChild(other_species_label);
        const other_species_list = document.createElement("ul");
        other_species_list.replaceChildren(...other_species)
        listitem.appendChild(other_species_list)
        other_species_container.replaceChildren(listitem);


        // other_species_container.appendChild(other_species_toggle)



        species_container.children[0].replaceChildren(...top_10_species)
        species_container.children[1].replaceChildren(other_species_container)

    }


    Chart.register("chartjs-plugin-annotation");

    bar_chart = new Chart('bar_chart', {
            type: "bar",
            data: {},
            options: {}
        }       
    );

    pie_chart = new Chart('pie_chart', {
            type: "doughnut",
            data: {},
            options: {}
        }       
    );


    draw_kmer_hist(bar_chart, pie_chart)
    draw_species_pie_chart(pie_chart)
    draw_species_list()

    
    const alert_user = '{{alert_user}}'
    if (alert_user === 'true'){
        alert('{{text}}')
    }

    const toggle_unclassified = () => {
        show_unclassified = !show_unclassified;
        draw_kmer_hist(bar_chart, pie_chart, species_list, k_mer_threshold)
        draw_species_pie_chart(pie_chart, species_list, k_mer_threshold)
    }

    
</script>

</html>