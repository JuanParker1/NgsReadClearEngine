<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genomefltr</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/main.css')}}">
    <script src="https://cdn.jsdelivr.net/npm/danfojs@0.3.3/lib/bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js"></script>
</head>


<body class="font-sans">
<div class='w-full h-screen bg-no-repeat bg-cover'
     style="background-image: url('static/images/background.jpg')">

    <div class="flex flex-row mx-auto  h-full">
        <div id="species_container">
            <div id="tester"></div>
        </div>
        <div id="tester_pie"> 
            <input id="slider" type="range">
        </div>
    </div>
</div>
</body>
<script>
    const species_container = document.getElementById("species_container");
    let new_index = []
    let new_data = {}
    const json_data = JSON.parse('{{ data|safe }}');
    Object.entries(json_data).map(([key, val]) => {
        new_data[key] = Object.values(val);
        new_index = Object.keys(val);
    })
    new_index = new_index.map((item) => parseFloat(item))
    df = new dfd.DataFrame(new_data, {index: new_index});
    
    //updates when pressing checkboxes
    let species_list = df.columns.filter(item => item != "Unclasified")
    //updates when moving the slider
    let k_mer_threshold = 0.01

    const draw_kmer_hist = (species_list, k_mer_threshold) => {


        sum_total_df = df.sum({axis: 0});

        const y_max = sum_total_df.max();

        
        sum_classified_df = df.loc({ columns: species_list }).sum({axis: 0});

        const classified_indexes = sum_classified_df.index

        const classified_values = classified_indexes.map((index) => {
            return index < k_mer_threshold ? 0 : sum_classified_df.loc([index]).values[0];
        })

        sum_classified_df = new dfd.Series(classified_values, { index: classified_indexes });

        sum_unclassified_df = sum_total_df.sub(sum_classified_df)

        let classified = {
            x: sum_total_df.index,
            y: sum_classified_df.values,
            type: 'bar'
        };

        let unclassified = {
            x: sum_total_df.index,
            y: sum_unclassified_df.values,
            type: 'bar'
        };

        const data = [unclassified, classified]

        let layout = {
            height: 480,
            width: 640,
            barmode: 'stack',
            shapes: [
    //line vertical
            {

            type: 'line',
            x0: k_mer_threshold,
            y0: 0,
            x1: k_mer_threshold,
            y1: y_max,
            line: {
                color: 'rgb(200, 200, 200)',
                width: 4,
                dash: 'dot'
            }
            }]
        };

        Plotly.newPlot('tester', data, layout, {staticPlot: true});

    }

    const draw_species_pie_chart = (species_list, k_mer_threshold) => {

        sum_total = df.sum({axis: 1}).sum({axis: 0});


        const threshold_list = df.index.filter(item => item >= k_mer_threshold)
        
        sum_classified_df = df.loc({ rows: threshold_list, columns: species_list }).sum({axis: 1});

        sum_unclassified = sum_total - sum_classified_df.sum({axis: 0});

        colors_classified = species_list.map(item => 'orange');
        colors_classified.push('rgb(200, 200, 200)');

        let pie_data = [{
            values: [...sum_classified_df.values, sum_unclassified],
            labels: [...sum_classified_df.index, "unclassified"],
            marker: {
                colors: colors_classified
            },
            type: 'pie'
        }];


        let layout = {
            height: 480,
            width: 640
        };

        Plotly.newPlot('tester_pie', pie_data, layout, {staticPlot: true});

    }
    
    draw_kmer_hist(species_list, k_mer_threshold)
    draw_species_pie_chart(species_list, k_mer_threshold)

    species_list.map((item) => {
        let toggle = document.createElement("label");
        toggle.setAttribute("id", "toggle_" + item);
        let checkbox = document.createElement("input");
        checkbox.setAttribute("type", "checkbox");
        checkbox.setAttribute("id", item);
        checkbox.setAttribute("checked", true);

        checkbox.addEventListener("change", (change) => {
            // console.log(change.target.id)
            const item = change.target.id
            if (species_list.includes(item)) {
                item_index = species_list.indexOf(item);
                species_list.splice(item_index, 1);
            } else {
                species_list.push(item)
            }
            draw_species_pie_chart(species_list, k_mer_threshold)
            draw_kmer_hist(species_list, k_mer_threshold)
        })
        toggle.appendChild(checkbox);
        let label = document.createElement("span");
        label.innerText = item;
        toggle.appendChild(label);

        species_container.appendChild(toggle);
    })

    const slider = document.getElementById("slider");
    slider.setAttribute("min", Math.min(...df.index));
    slider.setAttribute("max", Math.max(...df.index));
    slider.setAttribute("value", Math.min(...df.index));
    slider.setAttribute("step", 0.01);
    slider.addEventListener("change", (event) => {
        k_mer_threshold = event.target.value
        draw_species_pie_chart(species_list, k_mer_threshold)
        draw_kmer_hist(species_list, k_mer_threshold)
    });


</script>

</html>